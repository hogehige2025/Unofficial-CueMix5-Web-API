# Unofficial CueMix5 Web API

## 概要

このアプリケーションは、MOTU公式アプリケーション「CueMix 5」が操作するデバイスへの通信プロトコルを模倣し、HTTP APIおよびWeb UI経由でMOTUオーディオインターフェース（Ultralite-mk5など）を制御することを可能にします。古い（CueMix 5を使用しない）MOTUデバイスには対応していません。

![Web UI Screenshot](screenshot.png)

## 主な機能

### 制御可能なパラメータ
現在、CueMix5上の以下のパラメーターを制御可能です。

- Inputページ
    - Input Gain 1-8

- Outputページ
    - Monitoring
    - Phones
    - Output Trim 1-10

- 各 Mix
    - ボリューム
    - ミュート

## 疑似ミュート機能
各Input,Outputはミュート機能を持ちませんが、API上で疑似的にミュートを実現しています。
実際はボリュームを最低に下げているだけですが、変更前のボリュームを記憶しているのでミュートトグルのように動作します。

## リスニング用機能
スピーカー、ヘッドフォンの両方を使用している場合に有効な機能です。

- リスニング出力の切り替えスイッチ
  - MonitoringとPhonesを切り替え、どちらか一方を有効に、もう一方をミュートにします。

- リスニング出力用の疑似ボリューム
  - 疑似ボリュームを変化させると有効な出力のボリュームが変化します。

## Web UI
ブラウザから各パラメータを直感的に操作できます。

## Web API
すべての操作はシンプルなHTTPリクエストに対応しているため、Stream Deckのような外部デバイスからの制御ができます。

## 使い方 (For Users)

### 1. インストール

1.  GitHubの**リリースページ**から、最新の`uo_cm5_webapi_vX.X.X.zip`ファイルをダウンロードします。
2.  ダウンロードしたzipファイルを、好きな場所に展開（解凍）します。

フォルダ構成は以下のようになっています。
```
dist/
├── uo_cm5_webapi.exe  (アプリケーション本体)
├── public/              (Web UI関連のファイル)
├── windows/             (自動起動設定関連ファイル)
│   ├── EnableStartup.bat
│   └── DisableStartup.bat
│   └── SetStartupTask.ps1
│   └── template.xml
└── ...                  (その他の関連ファイル)
```

### 2. 初回起動と自動起動設定

1.  展開したフォルダ内の**`windows/EnableStartup.bat`**ファイルを**右クリックし、「管理者として実行」**を選択します。
2.  PowerShellスクリプトが実行され、タスクスケジューラにアプリケーションが登録され、`uo_cm5_webapi.exe`が起動します。
3.  ブラウザが自動的に開かない場合は、手動で`http://localhost:[listeningPort]`（デフォルト: `http://localhost:3000`）にアクセスしてWeb UIを表示します。
4.  Web UIの**「Connection Settings」**セクションで、お使いのMOTUデバイスのIPアドレス、ポート、シリアルナンバーを入力し、「Reconnect MOTU」ボタンをクリックしてください。これにより設定が保存され、MOTUデバイスとの接続が試行されます。
5.  Web UIを閉じてもアプリケーションはバックグラウンドで動作し続け、以降はPCログオン時に`uo_cm5_webapi.exe`が自動的に実行されるようになります。

### 3. アプリケーションの手動実行と自動実行の停止

*   **手動実行:**
    `uo_cm5_webapi.exe`をダブルクリックして実行します。
    起動後、ブラウザで`http://localhost:[listeningPort]`（例: `http://localhost:3000`）にアクセスするとWeb UIが表示されます。

### 3. アンインストール
=======
### 3. Web APIのURL生成
Web UIでボリュームなどの操作を行うと、`Control URL`セクションにURLが表示されます。
`Copy Control URL to Clipboard`ボタンをクリックすることでクリップボードにURLがコピーされます。

curl等でこのURLを開くことで同じ操作をAPI経由で行うことができます。
この操作を外部ランチャーやショートカットに登録することで簡単にボリュームをコントロールできます。

#### 例
- リスニング用ボリュームを-31dBに設定
    - `curl "http://localhost:3000/set?c=global&o=listening&v=-31"`

### 4. アンインストール
>>>>>>> develop
1.  展開したフォルダ内の**`windows/DisableStartup.bat`**ファイルを**右クリックし、「管理者として実行」**を選択します。
2.  PowerShellスクリプトが実行され、`uo_cm5_webapi.exe`が停止され、タスクスケジューラからアプリケーションが削除されます。
3.　必要に応じて設定ファイル `%appdata%\uo_cm5_webapi` フォルダを削除してください。

## 開発者向け (For Developers)

### セットアップ

1.  **リポジトリをクローンまたはダウンロードします。**
2.  **依存関係をインストールします。**
    ```bash
    npm install
    ```
3.  **開発モードで実行します。**
    ```bash
    npm start
    ```

### ビルド

スタンドアロン実行ファイル（`.exe`）をビルドできます。

**前提条件:** Node.js v20以上のバージョンがインストールされている必要があります。

```bash
npm run build
```

コマンドが完了すると、プロジェクトルートに`dist/`ディレクトリが作成され、その中に配布用のファイルが格納されます。zipアーカイブは`release/`ディレクトリに作成されます。

## MOTUデバイス メッセージフォーマット

本アプリケーションからMOTUデバイスへ送信されるメッセージは、特定の16進文字列フォーマットでWebSocket経由で送信されます。
本アプリケーションでは`commands.json`内に定義されています。

### 送信フォーマット

メッセージは以下の4つのパートから構成されます。

| フィールド   | バイト長 | 説明                                           |
| :----------- | :------- | :--------------------------------------------- |
| **ID**       | 2バイト  | コマンドの種類を識別するID。                   |
| **Index**    | 2バイト  | 操作対象のチャンネル等を指定するインデックス。 |
| **Length**   | 2バイト  | 後続の`Value`フィールドのバイト長。            |
| **Value**    | 可変長   | 実際の制御値。`Length`フィールドに依存します。 |

### 受信フォーマット

WebSocket接続時に全てのパラメータがMOTUデバイスから送信されてきます。
また、CueMix5や本体のノブからパラメータが変化した際は該当のパラメータの実が送信されてきます。

メッセージ送信フォーマットと同じですが、Lengthがありません。

| フィールド   | バイト長 | 説明                                           |
| :----------- | :------- | :--------------------------------------------- |
| **ID**       | 2バイト  | コマンドの種類を識別するID。                   |
| **Index**    | 2バイト  | 操作対象のチャンネル等を指定するインデックス。 |
| **Value**    | 可変長   | 実際の制御値。                                 |

### 値のエンコーディング

#### ミキサーボリューム (Mixer Volume)

-   `commands.json`では`type: 'mixvol'` として定義されるパラメータです。
-   **Length**: `4` バイト
-   **Value**: CueMix5やAPIで扱われるdB値が、内部的な計算式（`dbToHex`）によって4バイトの16進数値に変換されます。
    この16進数値は、`0x00000000` で-∞ dB（dB値が-100以下の時）、`0x01000000` で0 dBに相当します。最大値は+12 dBです。
    具体的な計算式は以下の通りです。

    **`HexValue = round(0x01000000 * 10^(dB / 20))`**

    ただし、`dB <= -100` の場合は `HexValue = 0x00000000` となります。

#### ゲインとトリム (Gain / Trim)

-   `commands.json`では`type: 'Gain'` や `type: 'Trim'` として定義されるパラメータです。
-   **Length**: `1` バイト
-   **Value**:
    -   **ゲイン**: CueMix5やAPIで扱われる値が、そのまま1バイトの整数値としてエンコードされます。(`+5db`の場合は`HexValue = 0x05`)
    -   **トリム**: CueMix5やAPIで扱われる値の**符号を反転させたもの**が、1バイトの整数値としてエンコードされます。(`-8db`の場合は`HexValue = 0x08`)

#### ミュート (Mute)
-   `commands.json`では`type: 'mixvol'`とセットで定義されています。
-   ボリューム制御とは別のID、インデックスを持ちます。
-   **Length**: `1` バイト
-   **Value**: `1`（ミュートON）または `0`（ミュートOFF）が1バイトの整数値として送信されます。

#### 例
- `Monitoring`のボリュームを-40dbにする場合
    - ID : `0x1393`
    - Index : `0x0000`
    - Length : `0x0001`
    - value : `0x28`
    - Send : `0x13930000000128`

- 例 `Main 1-2 Mix / Line 5` のボリュームを 0dbにする場合
    - ID : `0x03f8`
    - Index : `0x0004`
    - Length : `0x0004`
    - value : `0x01000000`
    - Send : `0x03f80004000401000000`



## HTTPエンドポイント

本アプリケーションは、以下のHTTPエンドポイントを提供します。

-   **`GET /`**
    -   コントロール用のWeb UIページを提供します。
-   **`GET /set`**
    -   URLパラメータを使用してコマンドの値を設定します。スクリプトやブックマークからの簡易的な操作に利用できます。
    -   **クエリパラメータ**:
        -   `o`: コマンド名 (例: `Monitoring`)
        -   `v`: 設定したい絶対値 (例: `v=-10`)
        -   `d`: 現在値からの差分 (例: `d=-2` or `d=2`)
        -   `m`: ミュート操作 (`m=1`でミュート, `m=0`でアンミュート, `m=t`でトグル)

-   **`PATCH /api/commands/{コマンド名}`**
    -   指定したコマンドの値を調整します。
    -   **リクエストボディ (JSON)**:
        -   `delta` (number, optional): 現在値からの差分。例: `{"delta": -2}`
        -   `value` (number, optional): 設定したい絶対値。例: `{"value": -10}`
        -   `mute` (string, optional): ミュート操作。`"t"` (トグル), `"0"` (ミュート解除), `"1"` (ミュート)。例: `{"mute": "t"}`
        -   `delta` と `value` は排他的です。`mute` と同時に使用できます。

## ライセンス

このプロジェクトは[MITライセンス](LICENSE)の下で公開されています。